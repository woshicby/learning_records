# 第三章 数据链路层

重要内容：①数据链路层的点对点信道和广播信道的特点，以及这两种信道说使用的协议（PPP协议以及CSMA/CD协议）的特点②数据链路层的三个基本问题：封装成帧、透明传输和差错检测③以太网MAC层的硬件地址④适配器、转发器、集线器、网桥、以太网交换机的作用和使用场合。

数据链路层的信道主要有以下两种类型：

点对点信道：这种信道使用一对一的点对点通信方式

广播信道：这种信道使用一对多的广播通信方式，过程复杂，且要使用专门的共享信道协议来协调不同主机的数据发送

网络层要讨论多个网络互联的问题，所以局域网属于数据链路层的范畴

## 3.1 数据链路层的几个共同问题（点对点信道和广播信道都通用）

### 3.1.1 数据链路和帧

链路/物理链路（link）：从一个节点到相邻接点的一段物理线路，中间没有任何其他的做交换节点，是一条路径的组成部分

数据链路/逻辑链路（data link）：用链路进行通信还需要必要的通信协议，把实现通信协议的硬件和软件加到链路上，就构成数据链路。

网络适配器（包括硬件和软件）：用于实现通信协议，使链路成为数据链路的系统，一般包括数据链路层和物理层这两层的功能

通信规程（procedure）：早期对数据通信协议的称呼，在数据链路层，规程和协议是同义语

帧：点对点信道的数据链路层的协议数据单元。

数据链路层的工作：把网络层交下来的数据构成帧发送到链路上，吧接收到的帧中的数据取出并上交给网络层。

点对点信道的数据链路层在进行通信时的主要步骤：

①节点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧

②节点A把封装好的帧发送给节点B的数据链路层

③节点B的数据链路层收到的帧无差错，则从收到的帧中提取出IP数据报交给上面的网络层，否则丢弃这个帧。

### 3.1.2 三个基本问题

#### 封装成帧（framing）：在一段数据前后添加首部和尾部，就构成了一个帧

接收端可以根据比特流中首部和尾部的标记而从比特流中识别出一个帧的开始和结束。

帧定界：首部和尾部的一个重要作用，即确定帧的界限。

首部和尾部还包括必要的控制信息。

链路层协议规定：首部和尾部的格式、最大传送党员（Maximum Transfer Unit，MTU）：能传送的帧的数据部分长度上限

帧定界符：数据是由==可打印的ASCⅡ码==组成的文本文件时，帧定界符可以用这种。

如SOH（Start of Header，二进制00000001）反正一帧的开头，表示首部开始，EOT（End of Transmission，二进制00000100）放在结尾表示帧的结束。

若收到只有SOH或者自由EOT就丢弃，只有完整的SOH和EOT才收下

#### 透明传输：不管所传数据是什么样的比特组合，都应当能够在链路上传送

问题：对于非ASCⅡ编码的文本文件，如果数据中某个字节正好=SOH或EOT，就会使得数据链路层错误地找到帧的边界，从而丢弃一段数据。

解决方法：在数据中出现的SOH、EOT、ESC前面插入一个转义字符ESC（十六进制1B，二进制00011011），接收端的数据链路层在把数据送往网络层之前删除这个ESC，就能获得原本的数据，这种方法叫做字节填充（byte stuffing）/字符填充（character stuffing）

#### 差错检测

比特差错：在传输过程中，比特可能会从1变成0，也可能会从0变成1.

误码率（Bit Error Rate，BER）：在一段时间内，传输错误的比特占所传输比特总数的比率。

循环冗余检验（Cyclic Redundancy Check，CRC）：一种在数据链路层广泛使用的检错技术。

CRC的过程：在发送端，先把数据划分为组，一组k个比特，在每组后面加提供差错检测的n位冗余码，构成一帧发送出去，一共发送（k+n）位，增加了传输的开销，但是可以进行差错检测

CRC运算过程：①用二进制模2运算进行$2^n$乘M的运算（即在M后面加上n个0）②除以收发双方事先商定的长度为（n+1）位的除数P，得到商Q余数R（n位）这个余数就作为帧检验序列加载M后一起发送

帧检验序列（Frame Check Sequence，FCS）：为了检错和添加的冗余码

CRC检验过程：每一帧都除以除数P，看看余数是否为0，为0则基本可以确定无误，不为0必有误。

CRC的功能：只能做到对帧的无差错接收（凡是接收端数据链路层接受的帧，我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错）

可靠传输：发送端发送什么，接收端就收到什么。传输差错可以分为两大类：比特差错和帧丢失/重复/失序（靠编号、确认、重传机制解决，TCP层）

数据链路层的态度：

①对通信质量良好的有线传输线路，数据链路层不使用确认和重传机制，即不要求数据链路层向上提供可靠传输服务，如果有差错并需要改正，由上层协议完成

②对通信质量较差的无限传输链路，使用确认和重传机制，向上提供可靠传输服务

为了提高通信效率。

## 3.2 点对点协议PPP[RFC 1661]

主要用于用户计算机和ISP进行通信时使用。淘汰了高级数据链路控制（High-level Data Link Control，HDLC），被淘汰的这个协议可以实现可靠传输。

#### PPP协议应该满足的要求

①简单：可以提高协议的互操作性（不同厂商设备的交互），只提供CRC检验②封装成帧：有帧定界符③透明性：可以透传④多种网络协议：支持多种网络层协议⑤多种类型链路：可以在不同类型链路上运行⑥差错检测：丢弃有差错的帧⑦检测连接状态：检测链路是否正常⑧最大传输单元：设置最大传输单元，促进互操作性⑨网络层地址协商：提供一种机制使得网络层实体可以通过协商而知晓或配置各自的网络层地址⑩数据压缩协商：提供一种方法来协商使用数据压缩算法。

PPPoE：以太网上运行的PPP，是宽带上网的主机使用的链路层协议，把PPP封装在以太网帧中（当然添加了识别各用户的功能），宽带上网时数据传输速率高，可以让多个用户共享一条链路，不过现在一个用户用ADSL进行宽带上网，并不分享链路，也用PPPoE协议

为何PPP不使用设置序号：因为在TCP/IP协议族中，可靠传输由传输层的TCP协议负责，所以数据链路层的PPP协议不需要进行纠错，也不需要设置序号，也不需要进行流量控制。

PPP协议不支持多点线路，只支持点对点链路通信，只支持全双工链路。

#### PPP协议的组成：

①一个将IP数据报封装到串行链路的方法。支持异步链路，也支持面向比特的同步链路

②一个用来建立、配置和测试数据链路连接的链路控制协议（Link Control Protocol，LCP），可以协商一些选项

③一套网课控制协议（Network Control Protocol，NCP），分别致辞不同的网络层协议（IP、OSI网络层、DECnet、AppleTalk）

### 3.2.2 PPP协议的帧格式

#### 首部尾部字段的意义

标志字段（首部第1个字段、尾部第2个字段）：0x7E，表示一个帧的开始或结束，作为PPP的定界符。Ps.连续出现两个标志字段就说明这是个空帧，应当丢弃。

首部的第2、3个字段：首部字段A=0xFF，控制字段C=0x03，没有意义。

协议字段（首部第4字段）：表示运行的协议，0x0021表示IP数据报，0xC021表示PPP链路控制协议LCP的数据，0x8021表示是网络层控制数据。

尾部第1字段（2字节）：CRC的帧检验序列FCS

首部：0x7E、0xFF、0x03、协议字段（2字节）

尾部：FCS、0x7E

#### 透明传输：字节填充/零比特填充

信息部分出现0x7E时，进行字节填充或零比特填充来实现透传。

异步传输：①在0x7E和0x7D前加入转义符：0x7D。②出现ASCⅡ码的控制字符（＜0x20），则前面插入0x7D，本体+0x20，如0x03→0x7D23）

同步传输（如SONET/SDH链路）：发送端扫描信息字段，出现5个连续1就加入一个0，可以保障信息字段没有6个连续1（而0x7E为01111110，正好有6个连续1）；接收端先找到0x7E，再怼信息字段扫描，5个连续1，就在后面删除一个0，还原原数据。

### 3.2.3 PPP工作状态

①链路静止（Link Dead）状态：起始和终止状态，不存在物理层连接

②链路建立（Link Establish）状态：双方建立了物理层连接（个人用户通过调制解调器呼叫路由器）

链路建立阶段：LCP开始协商配置选项，发送LCP配置请求帧（Configure-Request），协议字段0xC021，信息字段包含配置请求。链路另一方回复Configure-Ack（配置确定帧：接收）、Configure-Nak（配置否认帧：能理解不接受）或Configure-Reject（配置拒绝：不能识别或不能接收，要协商）帧

LCP配置选项：链路上最大帧长、使用的鉴别协议（如果有的话）

③鉴别（Authentication）状态：这个状态只允许发送LCP协议分组。

口令鉴别协议（Password Authentication Protocol，PAP）：发起通信的一番发送身份识别符和口令（可以试很多次）

口令握手鉴别协议（Challenge-Handshake Authentication Protocol，CHAP）：鉴别失败则进入链路终止状态、鉴别成功则进入网络层协议状态

④网络层协议（Network-Layer Protocol）状态：两端的网络控制协议NCP根据网络层的不同协议交换网络层特定的网络控制分组。

以IP为例：这时的NCP就是IPCP协议，IPCP分组封装成PPP帧（协议字段0x8021）在PPP上传送。在低速链路上还可以协商使用压缩的TCP和IP首部，减少比特数。

⑤链路打开（Link Open）状态：可以发送各种分组了，这是还可以发送回送请求LCP（Echo-Request）分组和回送回答LCP（Echo-Reply）分组，以检查链路状态。

数据传输结束后，发送终止请求LCP分组（Terminate-Request）请求终止链路连接，收到终止确认LCP（Terminate-Ack）分组后进入链路终止状态。

⑥链路终止（Link Terminate）状态：结束了链路层信息发送，调制解调器载波未停止

载波结束后回到链路静止状态。

PPP协议不仅仅是数据链路层的协议，还包含了物理层和网络层的内容

## 3.3 使用广播信道的数据链路层

主要就是局域网

### 3.3.1 局域网的数据链路层

局域网最主要的特点：网络为一个单位所拥有，地理范围和站点数目都有限。

局域网的有点①具有广播功能，从一个站点可以方便地访问全网。局域网上的主机可以共享连接的局域网上的各种硬件软件资源②便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变③提高了系统的可靠性、可用性和生存性。

拓扑结构：星形网/集线器网络、环形网、总线网

共享信道的方法：①静态划分信道：频分、时分、波分、码分复用，代价高，不适合局域网②动态媒体接入控制/多点接入：信道并非在用户通信时固定分配给用户，又分为随机接入和受控接入。

随机接入：所有用户可以随机发送信息，若有几个用户同时发送，就产生碰撞，所以要有解决碰撞的网络协议

受控接入：不能随时发送信息而是要进行控制，如令牌环网和轮询/集中控制的多点线路探询（polling）

以太网属于随机接入。

#### 以太网的主要标准

数据链路层分为逻辑链路控制（Logical Link Control，LLC）子层和媒体接入控制（Medium Access Control，MAC）子层。

#### 适配器的作用

适配器（adapter）/网络接口卡/网卡：装有处理器和存储器，用于有和I/O总线连接的接口和与网络连接的接口，实现数据链路层和物理层的功能。

硬件地址在网络接口卡的适配器ROM中，逻辑地址（IP地址）在计算机的存储器中。

### 3.3.2 CSMA/CD协议

局域网上的主机=主机=工作站=站点=站

以太网的通信措施：①采用灵活的无连接的工作方式，不编号，不确认，不可靠的交付，重传由上层决定，但对以太网透明②同时只允许一台主机发送数据②使用曼彻斯特编码的信号（高变低=1，低变高=0）

Ps.查分曼彻斯特：0不变1变（出现1就把上升沿变成下降沿或反之）

载波监听多点接入/碰撞检测（Carrier Sense Multiple Access  with Collision Detection）：以太网通信使用的协议。

多点接入：总线形网络，载波监听：边发边监听，碰撞检测

CSMA/CD只能进行双向交替通信（半双工通信）

单程端到端传播时延记为τ（电磁波在1km电缆的传播时延大概5μs）

争用期（contention period）/碰撞窗口（collision window）：经过这段时间之后没有检测的碰撞，就能肯定这次发送没有发生碰撞。一般为2τ

截断二进制指数退避（truncated binary exponential backoff）：不是等到信道空闲就重新发送，而是退避一个随机的时间。

①基本退避时间=争用期2τ，一般取51.2μs，为了方便，直接用比特错位争用期的范围，对于10Mbit/s以太网，争用期为512比特。

②从$[0,2^k-1]（k=Min[重传次数，10]）$中随机取一个数r，退避的时间=$r×争用期$

③重传达到16次还不成功，说明网络太忙，丢弃该帧，并向上层报告。

动态退避：根据上面的抽取规则，重传次数越多，抽出的退避时间的期望就越大。

为何10Mit/s以太网规定最短帧长64字节：如果帧太短：发送站发送完成之后这个帧才发生碰撞，而发送站不知道，这不好。64字节正好为512比特，也就是争用期。所以小于64字节的帧都是由于冲突而异常终止的无效帧。

强化碰撞：发送站发现碰撞之后除了停止发送数据，还要再发送32bit或48bit的人为干扰信号（jamming signal）让所有用户知道发生了碰撞。

以太网规定帧间最小间隔9.6μs，为了使刚刚接收到数据帧的站的接收缓存来得及处理。

CSMA/CD要点：组帧完成，准备发生时先检测信道，边发边监听，争用期内无碰撞，认为发送成功，有碰撞，退避r倍512比特时间重传，重传16次不成功，丢弃上报

发送完之后要稍微保存一下为重传做准备。

### 3.3.3 星形拓扑和集线器

10BASE-T双绞线以太网的出现是局域网发展史上的一个非常重要的里程碑。（BASE表示基带信号，T表示双绞线）

集线器特点：

①表面上看像是星形网，逻辑上相当于总线网，使用CSMA/CD协议，同时至多只允许一个站发送数据

②集线器有多个端口（指硬件端口，和运输层的软件端口无关）

③集线器工作在物理层，仅简单转发比特，不进行碰撞检测

④集线器采用专门芯片，自适应串音回波抵消，可以使端口转发出去的较强信号不对该端口收到的较弱信号产生干扰。每个比特转发前还要再生整形和重新定时

集线器本身非常可靠，有少量的容错能力和网络管理功能

### 3.3.4 以太网的信道利用率

参数$a=\frac{τ}{T_0}$是以太网单程端到端时延τ和发送时间$T_0$的比值

a→0时一发生碰撞就立即可以检测出来，并停止发送

a越大表示争用期占比越大，信道利用率低，所以要尽量缩小a的值

即以太网连线长度受限（否则τ太大），以太网帧长不能太短（否则$T_0$太小）

极限利用率（不发送碰撞的情况）$S_{max}=\frac{T_0}{t_0+τ}=\frac{1}{1+a}$

### 3.3.5 以太网的MAC层

局域网中，硬件地址又称为物理地址或MAC地址（因为用于MAC帧中）

MAC地址：也叫做硬件地址、物理地址，是适配器地址或适配器标识符EUI-48。

以太网mac帧包括：单播、广播、多播

混杂方式（promiscuous mode）：一种特殊的以太网适配器工作方式，把路过的帧都接收下来（其实算是窃听）嗅探器就使用了这种模式。

#### MAC帧的格式

两种标准，主要用DIX Ethernet V2（简写为V2）标准，另一种是IEEE的802.3标准

==V2的MAC帧==：目的地址（6字节）、源地址（6字节）、类型（2字节，表示上层协议）、数据字段（46-1500字节）、帧检验序列FCS（4字节，CRC校验）

使用曼彻斯特编码，发送完后就不发送码元（上升或下降），自然可以知道没内容了。

数据长度若<46字节，加入一个整数字节的填充字段，使MAC帧长不小于64字节。

进入物理层前加入7个字节的前同步码（用于同步时针频率/实现位同步）+1字节的帧开始定界符（10101011，最后的11告诉对方MAC帧的信息马上来了）

==IEEE802.3的MAC帧==：出现以下情况就是无效的MAC帧，直接丢弃

①长度不是整数个字节②FCS有差错③数据字段长度不在46-1500字节之间；即帧长度不在64-1518字节之间

V2和IEEE802.3的MAC帧的差别：

①IEEE的第三个字段为长度/类型，这个指大于0x0600时表示类型，小于0x0600时表示长度，长度和实际收到的不符也为无效帧（由于使用曼彻斯特编码，长度字段其实没啥用）

②IEEE的长度字段小于0x0600时，数据字段只能使用LLC子层的LLC帧（现在已经基本不用了）

③IEEE的文档里把前同步码和帧开始定界符也包括在帧格式里。

## 3.4 扩展的以太网

在物理层和数据链路层进行扩展，在网络层看起来还是一个网络

3.4.1 物理层扩展以太网

法一、延长距离：中间加光纤，靠光纤调制解调器（时延小，带宽宽）

法二、多个集线器进行二层三层的连接（扩大了地理方位，但冲突域更大了，而且不同的以太网技术也不能互联（只能使用其中最低的一个））

### 3.4.2 数据链路层扩展以太网

用交换机/二层交换机（L2 switch）/交换式集线器（switching hub）/以太网交换机。

#### 以太网交换机的特点

本质上是一个多端口的网桥，一般工作在全双工模式，

具有并行性，能同时连通多对端口，使多对主机同时通信，都能独占传输媒体，无碰撞的传输数据。

有存储器，可以缓存忙时的帧。

可即插即用，内部的帧交换表/地址表是自学习来的

性能远超集线器，价格又不贵

一般有多个多种速率的端口，方便不同情况的用户

有的交换机不搞存储转发，直接直通（cut-through），优点是硬件交叉矩阵，交换时延小，缺点是没有差错，可能转发无效的帧出来

有些功能必须得存储转发：线路速率匹配、协议转换、差错检测

#### 以太网交换机自学习功能的bug

有的冗余链路会导致有帧兜圈。解决方法：生成树协议（Spanning Tree Protocol，STP）在逻辑上切断一些链路，是的从一台主机到其他所有主机的路径都是无环的。

#### 总线以太网到星形以太网

使用交换机，不用CSMA/CD协议了，但还是使用以太网的帧结构

### 3.4.3 虚拟局域网VLAN

增加了一个VLAN标签字段来分割广播域，加入这个字段的帧叫做802.1Q帧

格式：目的地址（6字节）、源地址（6字节）、VLAN标签（4字节：0x8100（IEEE802.1Q标签类型）、4位无用、12位VLAN标识符VID）、类型（2字节）、数据（46-1500字节）、帧检验序列FCS（4字节）

划分VLAN，在路由器处按端口/MAC地址划分，主机不知道自己的VID值，主机-交换机链路上都是普通的帧，交换机之间的交换时会在头部中插入VLAN标签，成为802.1Q帧。

汇聚链路（trunk link）/干线链路：连接两个交换机端口之间的链路

第三层交换机/L3L2交换机：有的交换机加入了专用芯片的转发模块，用于在不同VLAN之间转发帧，就不用传给路由器了，而且硬件转发更快

## 3.5 高速以太网

100BASE-T：争用期变成5.12μs，帧间最小间隔0.96μs，变成10BASE-T的十分之一

1000BASE-T（吉比特以太网）：半双工用CSMA/CD，全双工不用，

使用载波延伸（carrier extension）：最短MAC帧长还是64字节（为了兼容），争用期增大为512字节（原本是512位），不足512字节的要补充到512字节再发

分组突发（packet bursting）：有多个短帧发送时，第一个用载波延伸加长（占线路），后面就顺着，保留最小帧间间隔，逐个发送，知道1500字节或稍微多一点为止

全双工的话就不用载波延伸和分组突发了。

10GBASE-T：只工作在全双工

40GBASE-T、100GBASE-T也都只工作在全双工

现在广域网也用以太网，好处：①以太网是成熟技术②以太网互操作性好③以太网价格比同步光纤网便宜多了，还能适应多种物理媒体④端到端全都是以太网，不用转格式，简化操作和管理。

以太网：可拓展、灵活、易于安装、稳健性好

### 3.5.4 用以太网进行光带接入

PPPoE：把PPP帧封装到以太网帧中直接整。
