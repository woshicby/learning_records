# 第四章 网络层

重要内容：①虚拟互连网络和两种服务、两个层面的概念。②IP地址与MAC地址的关系。③传统分类的IP地址和无分类域间路由选择CIDR。④路由选择协议的工作原理

## 4.1 网络层的几个重要概念

### 4.1.1 网络层提供的两种服务

虚电路（Virtual Circuit）服务和数据报（datagram）服务

互连网的设计思路：网络层设计得尽量简单，向其上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

网络层不提供服务质量的承诺：传送的分组可能出错、丢失、重复、失序，也不保证分组交付的时限

| 对比的方面                 | 虚电路服务                                     | 数据报服务                                         |
| -------------------------- | ---------------------------------------------- | -------------------------------------------------- |
| 思路                       | 可靠通信应当由网络来保证                       | 可靠通信应当由用户主机来保证                       |
| 连接的建立                 | 必须有                                         | 不需要                                             |
| 终点地址                   | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有终点的IP地址                           |
| 分组的转发                 | 属于同一条虚电路的分组均按照同一路由进行转发   | 每个分组独立查找转发表进行转发                     |
| 当节点出现故障时           | 所有通过故障节点的虚电路均不能工作             | 出故障的节点可能会丢失分组，一些路由可能会发生变化 |
| 分组的顺序                 | 总是按发送顺序到达终点                         | 到达终点的顺序不一定按照发送的顺序                 |
| 端到端的差错处理和流量控制 | 可以由网络负责，也可以由用户主机负责           | 由用户主机负责                                     |

### 4.1.2 网络层的两个层面

路由器之间传送的信息有以下两大类：①转发源主机和目的主机之间所传送的数据②传送路由信息

网络层分为数据层面（转发层面）和控制层面（control plane）

数据层面：根据本路由器的转发表，把收到的分组从查找到的对应接口转发出去，常常用硬件进行转发（为了加快转发的速率），转发一个分组的时间为纳秒（
$10^{-9}$秒）数量级。

控制层面：根据路由协议所用的路由算法计算路由（使用软件），一般是秒的数量级。要根据相邻的路由器发来的路由信息进行运算

软件定义网络（Software Defined Network，SDN）：所有的路由器之间不再交换路由信息，而是由一个逻辑上集中的远程控制器来掌握各主机和整个网络的状态，为每个路由器计算正确的转发表

## 4.2 网际协议IP[RFC 791]

网际协议（Internet Protocol，IP），与之配套使用的协议：①地址解析协议ARP（Address Resolution Protocol）②网际控制报文协议ICMP（Internet Control Message Protocol）网际组管理协议IGMP（Internet Group Message Protocol）

逆地址解析协议RARP（Reverse Address Resolution Protocol）已经淘汰不用了，因为在动态主机配置协议DHCP协议中已经包含了RARP的功能

IP经常使用ARP；ICMP、IGMP经常使用IP

### 4.2.1 虚拟互联网络

需要解决的问题：不同的寻址方案、不同的最大分组长度、不同的网络接入机制、不同的超时控制、不同的差错恢复方法、不同的状态报告方法、不同的路由选择技术、不同的用户接入控制、不同的服务、不同的管理与控制方式……

因为没有一种单一的网络能适应所有用户的需求，所以将网络互相连接起来需要使用一些中间设备，如物理层的转发器（repeater）、数据链路层的网桥/桥接器（bridge）、交换机（switch）、网络层的路由器（router）、网络层以上的网关（gateway）

使用IP协议可以使性能各异的网络在网络层上看起来好像是一个统一的网络，使用IP协议的虚拟互联网络简称为IP网。

用IP的好处：当IP网上的主机进行通信时，好像在单个网络上通信一样，看不见互联的各网络的异构细节，如果在覆盖全球的IP网上层使用TCP协议，那就是互联网（Internet）

间接交付：中间需要经过一个或几个路由器

直接交付：中间不需要经过路由器（说明源主机和目的主机的同一个网络上）

互联网可以由多种异构网络互连组成

跳（hop）：分组在传送途中的每一次转发成为一跳

下一跳（next hop）：指下一次转发分组的目的地

### 4.2.2 IP地址

IP地址由互联网名字和数字分配机构（Internet Corporation for Assigned Names and Numbers，ICANN）进行逐级分配

如：ICANN分配给APNIC（亚太网络信息中心Asia Pacific Network Information Center），APNIC分配给CNNIC（中国互联网信息中心），CNNIC分配给各个ISP，IP地址都是有偿租用的。

点分十进制记法（dotted decimal notation）：一种表示IP地址的方法

每个主机/路由器的接口分配一个IP地址，IP地址不仅标记了这个主机，还标记了此接口连接的网络。

IP地址分为网络号和主机号，IP地址::={<网络号>,<主机号>}，IP地址指明了连接到某个网络上的一个主机/路由器。

#### 4.2.2.2 分类的IP地址（早期用法）[RFC 1812]

分为A类（0打头）、B类（10打头）、C类（110打头）、D类（1110打头，作为多播地址）、E类（1111打头，作为保留地址）

IPv4地址空间一共有$2^{32}（4294967296，约为43亿）$个地址，A类占$2^{31}$个地址，B类占$2^{30}$个地址，C类占$2^{29}$个地址，D类和E类占$2^{28}$个地址

IP地址指派：

| 网络号 | 主机号             | 作为源地址使用 | 作为目的地址使用 | 代表的意思                            |
| ------ | ------------------ | -------------- | ---------------- | ------------------------------------- |
| 0      | 0                  | 可以           | 不可以           | 在本网络上的本主机（DHCP常用）        |
| 0      | X                  | 可以           | 不可以           | 在本网络上主机号为X的主机             |
| 全1    | 全1                | 不可以         | 可以             | 只在本网络上进行广播（路由器不转发）  |
| Y      | 全1                | 不可以         | 可以             | 对网络号为Y的网络上的所有主机进行广播 |
| 127    | 非全0或全1的任何数 | 可以           | 可以             | 用于本地软件环回测试                  |

$$A类地址可分配的主机数=2^{24}-1=16777214$$（减去主机号全0和全1）

$$A类地址可分配的网络号=2^{7}-2=126$$（网络号有8位，前1位被固定，还要减去网络号全0的本网络和网络号为01111111（十进制为127）的环回测试）

$$B类地址可分配的主机数=2^{16}-2=65534$$（减去主机号全0和全1）

$$B类地址可分配的网络号=2^{14}=16384$$（网络号有16位，前2位被固定）

$$C类地址可分配的主机数=2^{8}-2=254$$（减去主机号全0和全1）

$$C类地址可分配的网络号=2^{21}=2097152$$（网络号有24位，前3位被固定）

#### 4.2.2.3 无分类编址CIDR

无分类域间路由选择（Classless Inter-Domain Routing，CIDR）：网络号改称为网络前缀（network-prefix）

斜线技法（slash notation）/CIDR记法：IP地址后加上斜线，后跟随网络前缀所占的位数

CIDR地址块：网络前缀都相同的所有连续的IP地址组成一个CIDR地址块。（每个地址块的可指派地址也要扣除主机号全0和全1）

地址掩码/子网掩码：方便计算机迅速从IP地址中算出网络地址（按位AND运算得网络地址）

特殊地址块：①前缀n=32，没有主机号，其实就是一个IP地址，用于主机路由（host route，对特定目的主机的IP地址专门指名的一条路由，放在转发表的第一项）②n=31，这个地址块只有两个IP地址，用于点对点链路（只需要两个IP地址，所以可以使用/31地址块。但常常是不分配IP地址的，不分配IP地址的话叫做无编号网络或匿名网络）③n=0，IP地址也为全0，即0.0.0.0/0，用于默认路由

CIDR也称构造超网，网络前缀越短的地址块所包含的地址数就越多。

CIDR的好处：更加有效地分配IP地址空间。

路由聚合（route aggregation）：在路由器的转发表中，用一个较大的CIDR地址块来指代多个较小的CIDR地址块

#### 4.2.2.4 IP地址的特点

①由网络前缀和主机号组成，IP地址管理机构在分配IP地址时只分配网络前缀，路由器根据目的主机的网络前缀来转发分组（好处：减少转发表所占的存储空间、缩短查找转发表的时间）

②IP地址标识一台主机/路由器和一条链路的接口，一台主机/路由器同时连接到多个网络上时，这台主机/路由器就有多个IP地址，称为多归属主机（multihomed host）

③用转发器或交换机连接起来的若干个局域网仍为一个网络。因为他们有相同的网络前缀。

④在IP地址中，所有分配到网络前缀的网络都是平等的

⑤网络地址的主机号必定是全0

### 4.2.3 IP地址和MAC地址

MAC地址（也称作物理地址或硬件地址）是数据链路层使用的地址，IP地址是网络层和以上各层使用的地址，是一种逻辑地址。

特点：

①IP层抽象的互联网上只能看到IP数据报

②虽然IP数据报首部有源IP地址，但路由器只根据目的IP地址进行转发

③在链路层只能看到MAC帧，每一跳都修改MAC帧的帧头。

④IP层抽象的互联网屏蔽了下层很复杂的细节，所以在网络层只上讨论问题就能够用统一的、抽象的IP地址来研究主机和主机或路由器之间的通信。

小问题：①主机或路由器怎样知道应该在MAC帧的首部填入什么样的MAC地址（用ARP）②路由器中的转发表是怎么得出的（路由算法）

### 4.2.4 地址解析协议ARP[RFC 826]

每台主机都设有一个ARP高速缓存（ARP Cache），用于存储本局域网上的各主机和路由器的IP到MAC的映射表。有需要MAC地址的时候直接查询

若要发送的目的主机B的MAC地址不在ARP高速缓存中（原因常常是主机B刚刚入网或主机A刚刚加电，缓存是空的），运行ARP。

ARP的步骤：

①ARP进程在本局域网上广播一个ARP请求分组，主要内容是“本机IP地址、本机MAC地址、要请求MAC地址的IP”（ARP请求分组直接封装在以太网帧里）

②本局域网上所有主机收到吃ARP请求分组后检查“要请求MAC地址的IP”

③若自己的IP地址与其一致，返回一个ARP响应分组，对请求方单播返回自己的MAC地址。（如果B不知道A的IP和MAC，可以从A的请求报文里直接获取并缓存）

④收到响应分组后，在ARP高速缓存中写入这条映射。

ARP的高速缓存中的每一条映射都有生存时间，生存时间达到后就被删除，而后有需要就重新请求。

IP到MAC的地址解析是自动进行的，主机的用户对此过程不知道。

为何不直接全都使用MAC地址：因为世界上存在着各式各样的网络，使用不同的MAC地址，要让这些网络能够互相通信就得进行非常复杂的MAC地址转换工作，几乎不可完成。而使用IP地址进行虚拟化就能够进行方便的通信了。

### 4.2.5 IP数据报的格式。

首部

版本（4位）：IP协议的版本

首部长度（4位）：首部长度有多少个4字节（32位），IP首部固定部分由20字节，所以这个字段的最小值是5，而最大值为15，IP数据报的首部最长可以是15个32字节，即60字节。不正好的话要用最后的填充字段进行填充。

区分服务（8位）：旧版本叫做服务类型，只有使用区分服务时才有用，平常不用[RFC 2474/3168/3260]

总长度（16位）：包括首部和数据的总长度，单位是字节，数据报最大长度$2^{16}-1=65535$字节（实际上基本不会有这么长的）

Ps.由于数据链路层的数据帧的数据字段有最大长度的限制（最大传输单元MTU(Maximum Transfer Unit），如以太网就是1500字节）所以IP数据报过长时要进行分片，分片后的总长度字段就是指这个分片的首部长度和该分片的数据长度的总和

标识（identification 16位）：每产生一个数据报，标识字段就被+1，但是因为IP是无连接服务，标识并不是序号，只是用于识别同一个数据报的分片而已。

标志（flag 5位）：目前只有两位有意义：①MF（More Fragment）：标志字段的最低位，=1是表示后面还有分片，=0时表示这是最后一个分片②DF（Don't Fragment）：标志字段中间的一位，意思是不能分片，DF=0时才运行分片

片偏移（13位）：相对于用户数据字段的起点，该片从何处开始，单位为8个字节，除了最后一个数据报片以外，每个分片的长度一定是8字节的整数倍。

生存时间（8位）：TTL（Time To Live）表明数据报在网络中的寿命，【早期设定】以秒为单位，每传递一次就减去在路由器里花的时间，不足一秒的话就减一秒，知道TTL降为0，就丢弃。【现在的设定】TTL改为跳数限制：每转发一次就-1，降到0就丢弃，所以数据报在互联网中至多可以经过255跳

协议（8位）：指出设个数据报携带的数据是什么协议，以便目的主机IP层知道要把数据部分交给哪个协议进行处理

| 协议名     | ICMP | IGMP | IP   | TCP  | EGP  | IGP  | UDP  | IPv6 | ESP  | AH   | ICMP-IPv6 | OSPF |
| ---------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | --------- | ---- |
| 协议字段值 | 1    | 2    | 4    | 6    | 8    | 9    | 17   | 41   | 50   | 51   | 58        | 89   |

首部校验和（16位）：用于检验数据报的首部，等于首部所有16位字的反码求和（0+0=0，0+1=1，1+1=0+进位，最高位有进位则在最低位+1）的反码

源地址和目的地址（各32位）：存储源IP地址和目的IP地址

可变部分：一堆选项字段

填充字段：用0补齐4字节

## 4.3 IP层转发分组的过程

### 4.3.1 基于终点的转发

路由器收到报文→获取报文中存储的目的IP地址→在自己的转发表中查找表项→得知下一跳的IP地址→使用ARP或者查询ARP Cache获取下一跳MAC地址→修改链路层帧的源MAC地址为自己转发出的端口的MAC地址，目的地址为查到的下一跳的MAC地址→打包好发给下一跳

### 4.3.2 最长前缀匹配

在查找转发表的时候，会匹配能匹配到最长网络前缀的一项。

每查询一项都会把目的IP和这一项的子网掩码按位求AND，然后和该行的前缀匹配。

主机路由（host route）：/32，最优先进行匹配

默认路由图（default route）：0.0.0.0/0，所有表项都匹配不到的话最后总能匹配到这一项

### 4.3.3 用二叉线索树进行查找

由于逐个查找匹配次数太多，最差情况下可能要查询32次直到默认路由

用二叉线索树来排出一些前缀与目的IP地址不匹配的表项。

（但是每次判断还是要和子网掩码按位求AND再确定。）

## 4.4 网际控制报文协议ICMP[RFC 792]

网际控制报文协议（Internet Control Message Protocol，ICMP）：允许主机或路由器报告差错情况和提供有关异常情况的报告，是互联网的标准协议。

ICMP的格式：类型（8位）、代码（8位）、校验和（16位）、（四个字节取决于ICMP报文的类型）、数据部分（长度取决于类型）

差错报告报文数据部分内容：收到的需要进行差错报告的IP数据报的首部+数据字段的前8个字节（这八个字节里有运输层的端口号（TCP/UDP）和运输层报文的发送序号（TCP）这些信息是有用的）

### 4.4.1 ICMP报文的种类

有两种：ICMP差错报告报文、ICMP询问报文。

| ICMP报文种类 | 类型的值 | ICMP报文的类型                      |
| ------------ | -------- | ----------------------------------- |
| 差错报告报文 | 3        | 终点不可达                          |
| 差错报告报文 | 11       | 时间超过                            |
| 差错报告报文 | 12       | 参数问题                            |
| 差错报告报文 | 5        | 改变路由（Redirect重定向）          |
| 询问报文     | 8、0     | 回送（Echo）请求或回送回答          |
| 询问报文     | 13、14   | 时间戳（Timestamp）请求或时间戳回答 |

信息请求与回答报文、地址掩码请求与回答报文、路由器请求与通告报文、源点抑制报文已经不再使用

终点不可达：路由器或主机不能交付数据报时告知源主机终点不可达

时间超过：当TTL=0而丢弃数据报时，要告知源主机

参数问题：路由器或目的主机收到的数据报首部有的字段值不正确时，丢弃并告知源主机

改变路由：告知主机下次把数据报发给别的主机（有更好的路由）

Ps.由于主机并不和连接在网络上的路由器定期交换路由信息（为了效率），而是把所有数据报转发给默认路由器。默认路由器发现有更好的路由，于是通知主机去往这个地址的数据报要发给另一个路由，主机就记录下来。

不应发送ICMP差错报告报文的几种情况：①对ICMP差错报文，不再发送ICMP差错报告报文②对第一个分片的数据报片的所有后续数据报片，不发送ICMP差错报告报文③对具有多播地址的数据报，不发送ICMP差错报告报文④对有特殊地址（如：127.0.0.0、0.0.0.0）的数据报，不发送ICMP差错报告报文

回送请求或回送回答：主机或路由器向特定的目的主机发出了询问，则该目的主机要给源主机/路由器发送ICMP回送回答报文（这种机制用于测试目的站是否可达以及了解其有关状态）

时间戳请求或时间戳回答：能够接收到对应的ICMP时间戳回答报文，用于计算当前网络的往返时延。

### 4.4.2. ICMP的应用

分组网间探测Ping（Packet InterNet Groper）：用于测试两台主机之间的连通性，使用了ICMP回送请求与回送回答报文，是应用层直接使用网络层ICMP的一个例子，没有经过TCP和UDP

```
C:\Users\user>ping mail.sina.com.cn

正在 Ping w5.dpool.sina.com.cn [183.60.95.173] 具有 32 字节的数据:
来自 183.60.95.173 的回复: 字节=32 时间=15ms TTL=53
来自 183.60.95.173 的回复: 字节=32 时间=15ms TTL=53
来自 183.60.95.173 的回复: 字节=32 时间=15ms TTL=53
来自 183.60.95.173 的回复: 字节=32 时间=15ms TTL=53

183.60.95.173 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 15ms，最长 = 15ms，平均 = 15ms
```

traceroute（UNIX系统）或tracert（Windows系统）：用于跟踪一个分组从源点到终点的路径

```
C:\Users\user>tracert mail.sina.com.cn

通过最多 30 个跃点跟踪
到 w5.dpool.sina.com.cn [183.60.95.173] 的路由:

  1    <1 毫秒   <1 毫秒   <1 毫秒 192.168.1.1
  2     *        *        *     请求超时。
  3     7 ms     1 ms     1 ms  【一个IP地址A】
  4     2 ms     2 ms     2 ms  【一个IP地址B】
  5     4 ms     4 ms     4 ms  【一个IP地址C】
  6     *        *        *     请求超时。
  7    46 ms    23 ms    22 ms  【一个IP地址D】
  8    18 ms    18 ms    18 ms  【一个IP地址E】
  9     *        *        *     请求超时。
 10     *        *        *     请求超时。
 11     *        *        *     请求超时。
 12    15 ms    15 ms    15 ms  183.60.95.173

跟踪完成。
```

Ps.中间有请求超时的原因：①那一跳禁PING①那一跳不对TTL超时做响应处理，直接丢弃③那一条属于某个MPLS网络

## 4.5 IPv6[RFC 8200]

IPv6的网络层协议数据单元PDU称为分组（packet）而不是IPv4的数据报（其实是一样的）

IPv6的主要变化：①更大的地址空间：128位，比IPv4的32位扩大了$2^{96}$倍②拓展的地址层次结构③灵活的首部格式④改进的选项：IPv6的首部长度是固定的，选项放在有效载荷里⑤允许协议继续扩充⑥支持即插即用（自动配置）：DHCP就不需要了⑦支持资源预分配⑧首部改为8字节对齐

IPv6分组包括：基本首部（base header）和有效载荷/净载荷（payload）。有效载荷里可以有几个扩展首部（extension header）+数据部分

IPv6首部字段的更改：取消首部长度字段（因为首部定长了）、取消服务类型字段（优先级和流标号实现了这个功能）、总长度改为有效载荷长度、取消了标识标志片偏移（放在扩展首部里）、TTL改名为跳数控制字段、协议字段改为下一个首部字段（类似指针）、取消了检验和（差错检测由传输层实现）、取消了选项（用拓展首部）

IPv6的基本首部的字段：

版本（version 4位，IPv4还是v6）

通信量类（traffic class 8位，区分不同的IPv6分组的类别和优先级）

流标号（flow label 20位，由于IPv6支持资源预分配，所以对于实时音视频数据这种又特别的流的，要设置一个流标号，可以使用预分配的资源，其他非实时的数据就设置为0）

有效载荷长度（payload length 16位，除首部以外的字节数，最多64KB（65535字节））

下一个首部（next header 8位，指向下一个首部，没有扩展首部时，这个字段直接表示后面数据所属的上层协议（如6表示TCP、17表示UDP））

跳数限制（hop limit 8位，就是TTL）

源地址（128位）、目的地址（128位）

6种扩展首部[RFC 8200]：①逐跳选项②路由选择③分片④鉴别⑤封装安全有效载荷⑥目的站选项

扩展首部的好处：IPv4中若使用了选项，则每个路由器都要检查首部的所有选项，看是否与本路由器相关，花费时间长，而IPv6中可以直接从下一个首部里看到有哪种类型的拓展首部。无关则不用检查。

### 4.5.2 IPv6的地址

单播（unicast）、多播（multicast）：广播直接看成多播的一个特例、任播（anycast）：交付给一组计算机中的任意一个均可

IPv6把每个主机和路由器称为节点，每个节点的每一个接口有一个IPv6地址

IPv6的记法：

点分10进制记法：和以前一样，更长了

冒号16进制记法（colon hexadecimal notation）如68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF

同组里数字前面的0可以省略，如:0CD3:→:CD3:

零压缩（zero compression）：一连串连续的0可以为一对冒号所取代，如：FF05:0:0:0:0:0:0:B3→FF05::B3

每个地址只能用一次零压缩

也可以用冒号16进制接点分10进制如：::128.10.2.1

CIDR斜线表示法也可以用，如：12AB::CD30:0:0:0:0:0/60或12AB:0:0:CD30::/60的前缀是12AB00000000CD3

但是取消了子网掩码（悲）

IPv6的地址类型：未指明地址：全0、环回地址：::1、多播地址：占总数的1/256、本地站点单播地址：内网使用，占总数的1/1024、本地链路单播地址：单一链路使用，占总数的1/1024、全球单播地址：可以灵活划分：1段（节点地址）、2段（子网前缀、接口表示符）、3段（全球路由选择前缀、子网标识符、接口标识符）

### 4.5.3 从IPv4向IPv6的过渡：

①双协议栈（dual stack）：根据DNS查询得到的是IPv4还是IPv6来选择使用哪个协议栈

②隧道技术（tunneling）：IPv6分组要进入IPv4网络时，作为IPv4数据报的数据部分封装，出来的时候在把数据部分给到IPv6协议栈（IPv4的协议字段设置为41表示数据报的数据部分是一个IPv6分组）

### 4.5.4 ICMPv6（把ARP和IGMP都整合在ICMPv6里了）

ICMPv6报文包括：差错报文、信息报文、邻站发现报文（Neighbor-Discovery，ND协议）、主成员关系报文（多播听众交付Multicast Listener Delivery，MLD协议）

## 4.6 互联网的路由选择协议

一个理想的路由算法应该满足：
①是正确和完整的（正确：即沿着各路由表所指引的路线，分组一定能够最终到达目的网络和目的主机）
②计算上应简单
③应能够适应通信量和网络拓扑的变化（自适应性/稳健性/鲁棒性）
④应具有稳定性（在网络通信量和网络拓扑相对稳定的情况下，算法结果也应该收敛到一个可以接收的解）
⑤公平的
⑥最佳的（相对某一种特定要求下得出的较为合理的选择）

路由算法的分类：
①静态路由选择策略/非自适应路由选择（不能随着网络的通信量和网络拓扑自适应得调整变化）：简单、开销小（适合于简单的小网络）
②动态路由选择策略/自适应路由选择（可以随着网络的通信量和网络拓扑自适应得调整变化）：复杂、开销大（适合于较复杂的大网络）

分层次的路由选择协议

为什么：①互联网的规模非常大，如果让所有的路由器知道所有的网络应怎样到达，那路由表将会非常大，处理起来也太花时间，路由器传递路由信息占据的带宽也过大②许多单位不希望外接了解自己单位网络的布局细节和本部门采用的路由选择协议，但还希望连接到互联网上。

怎么做：把整个互联网划分为许多较小的自治系统（autonomous system，AS），每个AS对其他AS所表现出的是一个单一的和一致的路由选择策略[RFC 4271]

自治系统：在单一技术管理下的许多网络、IP地址以及路由器，这些路由器使用同一种自治系统内部的路由选择协议和共同的度量。

路由协议画风为两大类：

内部网关协议（Interior Gateway Protocol，IGP）：在一个自治系统内部使用的路由选择协议，与其他自治系统使用什么路由选择协议无关

外部网关协议（External Gateway Protocol，EGP）：不同自治系统之间的路由选择就需要使用EGP

域内路由选择（intradomain routing）：自治系统内部的路由选择

域间路由选择（interdomain routing）：自治系统之间的路由选择

### 4.6.2 内部网关协议RIP

路由信息协议（Routing Information Protocol，RIP）：是一种分布式的基于距离向量的路由选择协议，是互联网的标准协议，最大有点：简单

距离向量：是一组从它自己到其他每一个目的网络的距离记录。

距离/跳数（hop count）：从一路由器到直接相连接的网络的距离定义为1，若没有直接相连，则每经过一跳距离+1（实际距离等于经过的跳数+1）

RIP认为好的路由就是经过的网络数目少，即距离短。

RIP允许一条路径最多只能包含15个网络，所以距离=16即不可达，所以RIP只适用于小型号互联网。

RIP只会选择一条具有较少网络数的路由（即使存在一条高速（低时延）但是网络数较高的路由）

#### 4.6.2.1 RIP的特点

①仅和相邻路由器交换信息②路由器交换的信息是当前路由器所知道的全部的信息（即自己的路由表）③按固定的时间间隔交换路由信息（如30s）

收敛过程：一个路由器刚刚开始工作时，它的路由表是空的。然后路由器和相邻的路由器交换更新路由信息。经过若干次的更新之后，所有路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址，从而收敛。

RIP报文通过UDP发送，使用UDP的端口520

RIP由首部和路由部分组成：路由部分要填入自制系统号（Autonomous System Number，ASN，一开始是16位，后来改为32位，由IANA分配），因为RIP有可能受到本自治系统以外的路由选择信息。一个RIP报文最多可以包含25个<目的网络地址（包括子网掩码）、下一跳地址、到此网络的地址>的路由，有更多的要再来一个RIP报文

#### 4.6.2.2 距离向量算法

目标：每个路由器到每一个目的网络的路由都是最短的



距离向量算法：RIP协议内自治系统内各个路由器根据交换到的信息更新自己路由表的算法

距离向量算法步骤：

①获取地址为X的相邻路由器发来的RIP报文，修改报文中的所有项目<目的网络,距离,下一跳>：

```
下一跳=X         //对于自己来说，若使用这个路由，那么下一跳就要发往X
距离=距离+1      //对于自己来说，若使用这个路由，那么距离比X所记录的要+1（多经过一个X）
```

②对修改后的每一项进行如下操作：

```
if(原路由表里没有目的网络Net)
	添加进路由表                                                   //是一个新网络，加入路由表
	elseif(下一跳路由器地址为X)
		把该项替换为新收到的项                                      //不是一个新网络，原有的这条路由距离变化了，要更新
		elseif(收到的项目中距离d<路由表中这一项的距离)
			进行更新，也就是用收到的这一项进行一个替换                //不是一个新网络，传来的这条路由距离比原来更近，要更新
		else 
			啥也不做                                              //不是一个新网络，传来的这条路由距离比原来更远，不更新
end	end end
```

③若3分钟还没有收到相邻路由器的更新路由表，则把此路由器设为不可达（距离=16表示不可达）

④循环

该算法的基础为Bellman-Ford算法/Ford-Fulkerson算法，要点：若X未A到B的最短路径上的一个节点，则A→X，X→B也是从A到X和从X到B的最短路径

#### 4.6.2.3 RIP的问题：坏消息传得慢

规模较大的网络中应该使用OSPF协议，小规模的网络中RIP用得多

网络出现故障时，要经过较长的时间才能将此信息传递到所有的路由器。

解决方法：让路由器记录收到某特定路由信息的接口，而不让同一路路由信息再通过此接口反方向传送

### 4.6.3 内部网关协议OSPF

开放最短路径优先（Open Short Path First，OSPF）：开放表面不受一家厂商控制，是公开发表的，最短路径优先是因为使用了Dijkstra算法，现在用的是OSPFv2[RFC 2328]

Ps.所有的自治系统内部使用的路由选择协议都是最短路径优先

OSPF最主要的特征：使用链路状态协议（link state protocol），而不是距离向量协议

OSPF协议的特点：

①利用洪泛法（flooding）（收到之后向除了信息源以外的所有相邻路由器发送信息）向自治系统中所有路由器发送信息。

②发送的信息是本路由器相邻的所有路由器的链路状态而不是整个转发表，链路状态<与哪个路由器相邻,链路的度量（metric）/代价>

链路的度量/代价：由网络管理人员来决定，可以表示费用、距离、时延、带宽等等。

Ps.此处的链路指和这两个路由器都有接口的网络

经过一系列的信息交换，所有的路由器就能建立一个链路状态数据库（link-state database），也就是全网的拓扑结构图，在全网范围内是一致/同步的。于是就可以同Dijkstra算法算出自己的路由表（RIP协议的路由器是不知道全网的拓扑结构的）

OSPF让每一个链路状态都带上一个32位的序号，序号越大状态越新，且规定链路状态序号增长的速率不得超过5秒1次，所以全部序号空间在600年内不会重复

#### 4.6.3.1 OSPF的层次结构区域划分

为了应用于更大规模的网络，OSPF自治系统再划分为若干个更小的范围，即区域（area）一般一个区域的路由器不超过200个

区域标识符：32位，用于表示OSPF自治系统内的区域，用点分十进制表示。

层次结构的区域划分：

主干区域（backbone area）：在上层的区域，标识符规定为0.0.0.0，用于连通下层的区域。

区域边界路由器（area border router）：连通两个区域的路由器

主干路由器（backbone router）：主干区域内的所有路由器

自治系统边界路由器（AS border router）：负责连通本自治系统和其他自治系统的路由器

#### 4.6.3.2 OSPF的五种分组

①问候（Hello）分组：发现和保持邻站的可达性（每10秒交换一次，有40秒没收到的话认为这个路由器不可达了，修改链路状态数据库并重算）

②数据库描述（Database Description）分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息

③链路状态请求（Link State Reqest）分组：向对方请求发送某些链路状态项目的详细信息

④链路状态更新（Update）分组：用洪泛法对全网更新链路状态，最复杂，最核心

⑤链路状态确认（Acknowledgment）分组：对链路更新分组的确认

同步：不同路由器的链路状态数据库内容一样

完全邻接的（fully adjacent）路由器：两个同步的路由器

OSPF交换路由信息的方法：①让每个路由器用数据库描述分组和相邻路由器交换本数据库中已有的链路状态的摘要信息。②交换路由器描述分组之后，使用链路状态请求分组，请求发送自己缺少的那些链路状态项目的详细信息③只要一个路由器的链路状态发生变化，就用可靠的洪泛法（收到之后要发送确认）向全网发出链路状态更新分组

为了确保链路状态数据库和全网的状态保持一致，每个一段时间要刷新一次数据库中的链路状态。（如30分钟）

因为每个路由器的链路状态只涉及相邻路由器的连通状态，所以没有坏消息传得慢的问题。

N个路由器连接在一个以太网上，则每个路由器要向其他N-1个路由器发送链路状态信息，一共有N(N-1)个链路状态要传送，对于这种相邻路由器过多的状态，OSPF采用了指定的路由器（designated router）的方法，使得这个路由器代表该局域网上所有的量了量向连接到该网络的各路由器发送状态信息

### 4.6.4 外部网关协议BGP[RFC 4271]

为何AS之间的路由选择不能用内部网关协议？

①互联网的规模太大，使得AS之间的路由选择非常困难（运行最短距离算法计算量过大）

②自治系统之间的路由选择需要考虑有关策略，并不能只选择最短距离（性能差距、政治、安全、经济等因素）

#### 4.6.4.1 BGP协议的主要特点

BGP只能力求旋出一条能到达目的网络前缀且比较好的路由，而并非要计算出最佳路由。

BGP使用路径向量（path vector）路由选择协议，与距离向量选择协议和链路状态协议都有很大区别

#### 4.6.4.2 BGP路由

AS中有边界路由器/边界网关和内部路由器

两个边界路由器连接时，建立TCP连接（端口号179），又称为半永久性连接（交换信息后仍然保持连接），这种TCP连接称为eBGP连接

eBGP连接可以交换BGP路由信息，如R1给R2发送<目的网络前缀X,经过的网络AS1,下一跳边界路由器R1>，R2就知道了“从R1经过AS1可以到达X”的BGP路由。

AS内部通过iBGP连接（用端口号179的TCP连接）来扩散这条BGP路由信息。

一个AS中的iBGP连接是全连通的（两两之间都有），通过iBGP收到的BGP路由不能再通过iBGP进行转告

iBGP和eBGP是同一个协议的两个部分。

BGP路由信息=<前缀,BGP属性>，

前缀：BGP的路由重点（子网前缀）

BGP属性有很多类型，最重要的就是AS-PATH（这条BGP路径经过的自治系统）和NEXT-HOP（下一跳）

构建转发表：

①假设AS内部路由器R4收到<X,AS1,R1>（这条BGP路由是从R2发来的←从TCP的源IP得知）

②查找R4的转发表中到达R2的最佳路由（用内部网关协议），在那一条转发表项中标注，可以到达X

每个路由器都这么干。

#### 4.6.4.3 三种不同的自治系统AS

末梢AS（stub AS）：比较小的AS，特点：这些AS把分组发送给直接连接的AS或者从直接相连的AS接收分组，而不会把一个AS来的分组发给另一个AS（基本要向其他AS付费）也可以连接到多个AS，就成为多归属AS（multihomed AS）提高连接的可靠性。

穿越AS（transit AS）：往往是拥有很好的高速通行干线的主干AS，彼此之间发送和接收分组都不收费

对等AS（peering AS）：经过事先协商的两个AS彼此之间发送接收分组都不收费

BGP路由不允许出现兜圈子：边界路由转发BGP路由之后，会在AS-PATH字段里加上自己的AS号。但发现新的BGP路由里出现两个自己的AS号时，就删除这条BGP路由不再转发。（AS-PATH属性中不允许出现相同的AS号）

#### 4.6.4.4 BGP的路由选择

只有一条BGP路由，就不用选了。有多条BGP路由的话，按以下的先后顺序来选：

①本地偏好LOCAL-PREF（LOCAL PREFerence）值最高的路由有限选择：本地偏好值可由路由器管理员或网络管理员根据经济或政治上的策略来设置

②选择AS跳数少的路由：经过AS个数少的路由（并不一定更好）

③热土豆路由选择算法：使转发的分组尽快离开本AS（运用内部路由选择协议）

④路由器BGP标识符数值最小的路由：BGP报文首部有一个4字节（32位）的BGP标识符（BGP ID），具有多个接口的路由器有多个IP地址，BGP ID就使用该路由器IP地址中数值最大的一个

#### 4.6.4.5 BGP的四种报文

①打开（OPEN）报文：用来与BGP连接对等端建立关系，相互识别对方，协商一些协议参数（如计时器的时间），回复保活报文表示接受连接。

②更新（UPDATE）报文：用来通告某一路由信息，列出要撤销的路由，一次可以撤销很多条，当时只能增加一条

③保活（KEEPALIVE）报文：周期性地证实与对等端的连通性，周期性交换，只包含BGP通用首部（19字节），不会产生多少开销

每个路由器都有保持时间计时器（Hold Timer），每收到一个BGP报文，就重置一次。在商定的时间内没收到任何BGP报文，就认为对方已经不能工作了。

发送保活报文的时间间隔取为保持时间（Hold Time）的1/3，保持时间也可以设为0，就永远不发送保活报文，认定对方永远在线。

④通知（NOTIFICATION）报文：用来发送检测到的差错

“坏消息传播得慢”问题在BGP可以容易地解决。某个路由器或链路出现故障时，可以从不止一个邻站获得路由信息，可以轻易选择出新的路由。

Ps.有两种BGP报文，一种ASN为2字节，另一种为4字节，路由属性记为AS4-PATH，新旧报文交换时要解决如何正确识别ASN的问题[RFC 6793]

| 路由协议         | 所属类型 | 优点                                                         | 缺点                                                         |
| ---------------- | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| RIP              | IGP      | 实现简单、开销较小                                           | ①最大距离为15限制了网络的规模<br>②交换的路由信息是整个路由表，随着网络规模加大，开销也变大<br>③坏消息传得慢，更新过程的收敛时间过长 |
| OSPF             | IGP      | ①更新过程收敛得快<br>②可以人工指派不同的代价，对于不同类型的业务可以计算不同的路由，灵活性好<br>③到一个目的网络有多条路径有多条相同代价的话可以实现负载均衡<br>④所有在OSPF路由器之间交换的分组都可以鉴别，保证只在可信赖的路由器之间交换信息。<br>⑤支持可变长的子网划分和CIDR |                                                              |
| OSPF层次区域划分 | IGP      | ①把洪泛法交换链路状态信息的范围局限于每一个区域<br>②区域内部交换路由信息的通信量减少，能够用于规模很大的自治系统中 | ①交换信息的种类增多了<br>②OSPF协议更加复杂了                 |
| BGP              | EGP      |                                                              |                                                              |
|                  |          |                                                              |                                                              |

### 4.6.5 路由器的组成

路由器：一种具有多个输入输出端口的专用计算机，其任务是转发分组。

转发分组：把从某个输入端口收到的分组，按照分组要去的目的地/目的网络，把该分组从路由器的某个合适的输出端口转发给下一跳路由器/目的主机。

路由器分为：路由选择部分/控制部分/控制层面、分组转发部分/数据层面

控制层面：核心构件是路由选择处理机，任务是根据所选定的路由选择协议构造出路由表，同时经常或定期与相邻路由器交换分组信息而不断更新和维护路由表

数据层面：由三部分组成：交换结构、一组输入端口、一组输出端口（这里说的端口就是指硬件端口）

交换结构（switching fabric）：又称为交换组织，作用就是根据转发表（forwarding table）对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。本身也是一种网络，可以看成“路由器中的网络”

|          | 转发表                                                       | 路由表                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 作用     | 用于转发：路由器根据转发表把收到的IP数据报从合适的端口转发出去（仅仅涉及一个路由器） | 用于路由选择：针对每个IP数据报选择一条合适的路径来进行传递（涉及多个路由器） |
| 定义     | 从路由表中得出，包含完成转发功能所必须的信息                 | 许多路由器协调工作的结果，按照复杂的路由算法，得出整个网络的拓扑变化情况，从而能够动态地改变所选择的路由，并由此得到完整的路由表 |
| 包含内容 | 包含从要到达的目的网络到输出端口、某些MAC地址信息的映射      | 仅包含从目的网络到下一跳的映射                               |
| 实现方法 | 可以用特殊的硬件实现                                         | 总是用软件实现                                               |

#### 4.6.5.1 线路接口卡

线路接口卡：一个路由器的输入端口和输出端口都做在线路接口卡上

输入端口：从线路接收分组→物理层处理（比特的接收）→数据链路层处理（剥除帧首部和尾部）→网络层处理（分组排队、查表和转发）→进入交换结构

输出端口：交换结构→网络层处理（分组排队、缓存管理）→数据链路层处理（加上链路层首部和尾部）→物理层处理→向线路发送分组

影子副本（shadow copy）：为了使交换功能分散化（让各个输入端口自己查表），往往把复制的转发表放在每个输入端口中，路由选择处理机负责对各转发表的副本进行更新，这些副本就是影子副本

线速（line speed或wire speed）：指输入端口的处理速度，最理想的情况下是能够跟上线路把分组传送到路由器的速率。如：OC-48链路，2.5Gbit/s，分组长度为256字节，那线速就应该逮到每秒处理100万以上的分组，即1Mpps（百万分组每秒）

分组丢失：由于分组处理的速率赶不上分组进入队列的速率，使得后到达的分组由于没有存储空间而被丢弃或设备或线路出现故障导致。

#### 4.6.5.2 交换结构

交换结构：通过存储器、通过总线、通过互连网络（interconnection network）/通过纵横交换结构（crossbar switch fabric）

通过存储器（最早的操作）：利用普通的计算机①输入接口收到分组时，触发中断通知路由处理机，分组复制到存储器中②处理机从分组首部提取目的地址，查找路由表，再复制到输出端口缓存中。（现代也有路由器采用这种操作，如Cisco的Catalyst 8500系列交换机）

若存储器带宽为每秒M个分组，则交换速率小于M/2

通过总线：数据报从输入端口通过共享总线直接传送到合适的输出端口，不需要处理机的干预。但由于总线是共享的，同时将只能有一个分组在总线上传送，所以有多个分组同时到达，会被阻塞。

目前总线速率已经可以满足小型企业网的需求，如思科的6500，背板总线速率32Gbit/s

通过互连网络：有2N条总线来连接N个输入端口和N个输出端口，控制器控制各个总线的交叉节点是否闭合。这种情况下分组可以转发到任何一个输出端口，只要这个输出端口没有被别的分组站有，如果输出端口已被占用，那么后到达的就要在输入端口排队等待（使用这种交换方式的路由器如：思科的12000系列交换路由器，互联网络速率达60Gbit/s）

## 4.7 IP多播

1988年首次提出，在一对多的通信中，可以大大节约网络资源。

多播在发送分组时只需要发送一次，路由器在转发的时候根据需要对分组进行复制，从多个端口转发。在局域网内，由于局域网能够硬件多播，所以不需要复制分组。

多播路由器（multicast router）：可以运行多播协议的路由器（当然也可以转发普通的单播IP数据报）

多播主干网（Multicast Backbone On the Internet，MBONE）：可以把分组传播给地点分散但属于一个组的许多台主机

IP多播：在互联网上进行多播（因为互联网使用TCP/IP协议栈）

多播组的标识符：相当于IP地址中的D类地址，前四位是1110，地址范围为224.0.0.0到239.255.255.255，共可标志$2^{28}$个多播组。

多播数据报并不保证一定能交付多播组内的所有成员

多播数据报和一般IP数据报的区别：用D类IP地址作为目的地址、首部协议字段为2，表明使用网际组管理协议IGMP

### 4.7.2 局域网内的硬件多播

互联网号码指派管理局IANA拥有的以太网地址框的高24位为00-00-5E，TCP/IP协议栈使用的以太网地址块范围是00-00-5E-00-00-00到00-00-5E-FF-FF-FF。

以太网MAC地址字段中的第一字节最低位为一时为多播，但IANA只拿出$2^{23}$个作为以太网多播地址。

所以以太网多播地址只有01-00-5E-00-00-00到01-00-5E-7F-FF-FF。（前25位固定不变，后23位可以表示不同的多播组）

后23位直接使用IP多播分组的后23位。所以收到多播数据报的足迹，还要在IP层再次判断是不是本主机要接收的数据报

```
                                 多出5位
IP地址                      1110 YYYY Y[YYY YYYY YYYY YYYY YYYY YYYY]
         0    1    0    0    5    E           对应使用下来
物理地址0000 0001 0000 0000 0101 1110 0 [XXX XXXX XXXX XXXX XXXX XXXX]
               ↓
            表示多播
```

### 4.7.3 网际组管理协议IGMP和多播路由选择协议

网际组管理协议（Internet Group Management Protocol，IGMP）：IGMP并非在互联网范围内对所有多播组成员进行管理（不知道多播组包含的成员数，也不知道这些成员都分布在哪些网络上），而是让连接在本地局域网上的多播路由器知道本局域网上是否有主机上的某个进程加入或退出了某个多播组。

多播路由选择协议：①需要动态地适应多播组成员的变化（即使网络拓扑未变化）②在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，还有考虑这个多播数据报从哪来到哪去③多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。

#### 4.7.3.2 网际组管理协议IGMP[RFC 3376]

IGMP使用IP数据报传递报文，也向IP提供服务。

##### IGMP的工作阶段

①某台主机加入新的多播组：该主机向多播组的多播地址发送一个IGMP报文，声明自己要成为该组的成员。本地多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器。

②组成员关系是动态的：本地多播路由器周期性探询本地局域网上的足迹，以便知道这些主机是否还继续是组的成员。只要有一个主机对某个组响应，那么就认为这个组是活跃的，如果探询了几次都没有响应，那就认为本网络上的主机都已经离开这个主，也就不再把这个组的成员关系转发给别的多播路由器。

##### 为避免多播控制信息给网络增加大量开销，IGMP采用的具体措施

①主机和多播路由器之间的所有通信都使用IP多播。只要可能，携带IGMP报文的数据报都用硬件多播来传送。这样没有参加IP多播的主机都不会收到IGMP报文。

②探询组成员关系时，只要对所有主发送一个请求信息的询问报文，而不是对每个组发送一个。默认询问速率是125秒发送一次

③同一个网络上连接几个多播路由器时，能迅速和有效地选择一个来探询主机的成员关系。

④IGMP询问报文有一个数值N，指名一个最长响应时间（默认10秒）收到询问时，主机在0到N之间随机选择发送响应经过的时延。若一台主机同时参加好几个多播组，则主机对每一个多播组选择不同的随机数，对应最小时延的响应最先发送。

⑤每一台主机都监听响应，如果同一组有其他主机响应了，就不用响应了。

#### 4.7.3.3 多播路由选择协议

多播路由选择协议还未标准化。

多播路由选择协议实际上就是要找出以源节点为根节点的多播转发树

多播转发树：多播路由器向树的子节点方向转发收到的多播数据报，但在多播转发树上的路由器不会受到重复的多播数据报

不同的多播组对应不同的多播转发树，同一个多播组，不同的源点也会有不同的多播转发树。

##### 转发多播数据报常用的方法

①洪泛和剪除：适合较小的多播组，所有组成员接入的局域网也是相邻接的。直接进行一个洪泛。

为了避免兜圈子，使用反向路径广播（Reverse Path Broadcasting，RPB）：每一个路由器收到多播数据报时，先检查本路由器到源点的最短路径上第一个路由器是否是多播数据报发来的路由器。是的话，往其他方向转发，不是的话丢弃。若有好几个相邻路由器都处在到源点的最短路径上，就选一个IP地址最小的（其实选哪个都无所谓）

剪枝：如果某路由器发现多播转发树的下游树枝都没有该多播组的成员，就把它和下游树枝一起剪掉，有加入了在接入。

②隧道（tunneling）技术：适用于多播组在地理上很分散的情况。有的路由器不支持多播，就把多播IP数据报再包入单播IP数据报进行传播（也就是IP-in-IP，和IPv6的隧道技术一样）

③基于核心的发现技术：对于多播组的大小在较大范围内变化时都适合。对每个多播组制定一个核心（core）路由器，给出核心路由器的IP地址，由核心路由器来创建对于多播组的转发树。

一个路由器R1向核心路由G发送数据报时，每个路过的路由器都检查其内容，到达一个属于这个多播组的路由器R2时，R2就处理这个数据报，

如果是这个组的多播，R2就向这个组的成员转发。

如果是请求加入，R2就把这个信息加入它的路由里，并用隧道技术向R1转发一个这个多播组的数据报的副本（这样R1就通过R2加入这个多播组了）

##### 多播路由选择协议举例

距离向量多播路由选择协议（Distance Vector Multicast Routing Protocol，DVMRP）：互联网上使用的第一个多播路由选择协议[RFC 1075]

基于核心的转发树（Core Based Tree，CBT）：[RFC 2089/2201]使用核心路由器作为转发树的根节点，一个大的AS分为几个区域，每个区域选择一个核心路由器/中心路由器/汇聚点路由器。

开放最短通路邮箱的多播扩展（Multicast extensions to OSPF）：作为OSPF的补充，用于一个机构以内，使用多播链路状态路由选择来创建多播转发树

协议无关多播-稀疏方式（Protocol Independent Multicast-Sparse Mode）：[RFC 7761]唯一成为互联网标准的协议，和CBT一样的方法构成多播转发树，这个协议适用于组成员的分布非常分散的情况。

协议无关：虽然建立多播转发树时是使用单播数据报来和远程路由器联系的，但这并不要求使用特定的单播路由选择协议。

协议无关多播-密集方式（Protocol Independent Multicast-Dense Mode）：[RFC 3973]这个协议适用于组成员分布非常集中的情况，使用洪泛法转发数据报。

## 4.8 虚拟专用网VPN和网络地址转换NAT

本地地址：机构内部有效的IP地址

全球地址：用于全球的互联网的IP地址

专用地址（private address）/可重用地址（reusable address）：有RFC1918（RFC 6890全面得规定了所有特殊用途的IPv4和IPv6地址，不过对于专用地址这部分没变化）规定了一些专用地址，只能用于做本地地址，而不能用于做全球地址。

用于专用地址的IPv4地址块：

10.0.0.0/8（一个A类网络）、172.16.0.0/12（16个连续的B类网络）、192.168.0.0/16（256个连续的C类网络）

Ps.10.0.0.0/8本来是给ARPANET的，不过ARPANET已经关闭了，就改为专用地址。

一个很大的机构的许多部门分布的范围很广，要互相交换信息，怎么办？

①租用电信公司的通信线路为本机构专用，简单方便，但线路租金过高，难以承受

②虚拟专用网（Virtual Private Network，VPN）：利用公用的互联网作为本机构各专用网之间的通信载体（常常需要加密）

### 4.8.1 虚拟专用网VPN

VPN只是在效果上和真正的专用网一样，实际是要经过公共网的。

构建VPN时要为它的每一个场所购买专门的硬件和软件，并进行配置，使得每一个场所的VPN系统都知道其他场所的地址。

利用IP隧道技术实现VPN：

①每一个场所的边界路由器都有公网IP。

②内部数据报到达边界路由器，发现要经过公共网，进行加密和重新封装，成为进入外网的外部数据报

③另一个地点的边界路由器收到外部数据报，进行解密，获得内部数据报，转发。

内联网（intranet）VPN：几个内部网络构成的VPN

外联网（extranet）VPN：有时需要外部机构参加进入VPN，这样的VPN就是外联网

远程接入（remote access）VPN：外地员工连接互联网，通过PC里的VPN软件建立VPN隧道接入公司内网。

### 4.8.2 网络地址转换NAT、NAPT

网络地址转换（Network Address Translation，NAT）：在专用网连接到互联网的路由器上安装NAT软件，装有NAT软件的路由器叫做NAT路由器，有公网IP这样使用本地地址的足迹在和外界通信时，都要在NAT路由器上将其本地地址转为全球IP地址，才能和互联网连接。

NAT路由器有多个全球IP地址时，专用网内最多可以同时有N台主机接入到互联网，就可以使专用网内较多数量的主机，轮流使用NAT路由器有限数量的全球IP地址。

专用网内的主机不能直接充当服务器使用：因为外界的主机主动发起通信，IP数据报到达NAT路由器时，NAT路由器就不知道应该把目的IP转换成专用网内的哪一个本地IP地址

更有效地利用全球IP地址，连端口号一起转换，就变成网络地址和端口号转换（Network Address and Port Translation，NAPT）

NAPT优点：把不同专用网内主机的网络层以上的包映射到统一IP地址的不同端口上，可以实现复用，节约IP地址。使用固定的端口映射甚至可以让专用网内的主机直接充当服务器

NAPT缺点：在网络层的操作却查看了传输层的端口号，破坏了按照层次工作的关系（但是它确实好用啊）

NAT转发表：<专用网IP,全球IP>

NAPT转发表：<专用网IP,专用网端口号,全球IP,全球端口号>

## 4.9 多协议标签转换MPLS

多协议标签转换（Multiprotocol Label Switching，MPLS）：在MPLS的上层可以采用多种协议，综合了Cisco的标签交换（Tag Switching）和Ipsilon的IP交换（IP Switching）等。

MPLS利用面向连接技术，每个分组携带一个叫做标签（label）的小整数，分组到达标签交换路由器/三层交换机时，读取分组的标签，用标签值检索转发表，比查找路由表要快一些。

MPLS与异步传递方式ATM（Asynchronous Transfer Mode）使用了面向连接的工作方式。

MPLS特点：①支持面向连接的服务质量②支持流量工程，均衡网络负载③有效地支持VPN

### 4.9.1 MPLS工作过程

重要特点：在MPLS域的入口处，给每一个IP数据报打上固定长度的标签，然后对打上标签的IP数据报进行标签交换

标签交换：用硬件技术对打上标签的IP数据报进行转发就称为标签交换，标签交换表示转发时不再上升到第三层查找转发表，而是在链路层用硬件进行转发，很快。

MPLS可以使用多种链路层协议：PPP、以太网、ATM、帧中继等都行

MPLS域（MPLS domain）：这个域中有许多彼此相邻的路由器，所有的路由器都是标签交换路由器

标签交换路由器（Label Switching Router ）：支持MPLS技术的路由器，同时具有标签交换和路由选择（因为LSR进行标签交换前也需要使用路由选择功能构造转发表）

MPLS工作过程

①MPLS域中的各LSR使用专门的标签分配协议（Label Distribution Protocol，LDP）交换报文（使用TCP其中的hello使用UDP），并找出和各个标签对应的路径，成为标签交换路径（Label Switched Path）LSR根据这些路径构造出转发表[RFC3031]

标签交换路径LSP上的第一个LSR就根据IP数据报的初始标签确定了整个标签交换路径。（整条路径都确定，就像虚连接一样的）

②一个IP数据报进入MPLS域时，MPLS入口节点（ingress node）就给他加上MPLS首部，并按照转发表转发给下一个LSR，之后所有的LSR就根据MPLS首部里的标签进行转发。

分类（classification）：给IP数据报打标签的过程，第三层/网络层分类只根据IP首部中的字段设置标签，还有第四层/运输层分类、第五场/应用层分类（也就是还要检查上层的首部进行分类。）

③分组每经过一个LSR就要：转发、更换新的标签（也叫做标签对换（label swapping）：入标签转换为出标签）也就是说每个标签也就用在两个LSR之间而已。

标签对换也有一个转发表<入接口,入标签,出接口,出标签>

④IP数据报离开MPLS域时，MPLS出口节点（egress node）就把MPLS的首部去除，把IP数据报交付给非MPLS的足迹和路由器。

MPLS使用的是显式路由选择（explicit routing）：由入口LSR确定进入MPLS域以后的转发路径

#### 4.9.1.2 转发等价类FEC

转发等价类（Forwording Equivalence Class，FEC）：路由器会按照同样方式对待（转发到一样的下一跳，有一样的服务类别和一样的丢弃优先级）的IP数据报的集合

FEC的例子：①目的IP和某一个特定IP地址的前缀匹配的IP数据报②所有源地址和目的地址都相同的IP数据报③具有某种服务质量要求的IP数据报

划分FEC由网络管理员来控制，入口节点会给属于同样FEC的IP数据报指派一样的标签。

FEC用于负载均衡：手动设置多种FEC来控制不同的IP数据报走不通的路径。

流量工程（Traffic Engineering，TE）：对网络上的通信量进行测量、建模和控制，使得网络运行的性能得到最优化，设置FEC是流量工程的常见操作。

### 4.9.2 MPLS首部的位置和格式

MPLS的首部位于链路层和网络层IP首部之间，进行链路层封装的时候，对于MPLS数据报就会设置一个特殊的类型字段值（如以太网的类型字段在有MPLS首部的单播就设置为8847（16进制），有MPLS首部的多播设置为8848（16进制），这样就可以根据帧类型的字段来判定这是个有MPLS首部的还是常规的IP数据报）

MPLS首部（4字节，20+3+1+8=32位）包括：

标签值（20位）：最多可以同时容纳$2^{20}$个流，实际上不会有那么多的，因为基本上需要管理员人工管理和设置交换路径

试验位（3位）：用于试验

S（1位）：表示栈（stack），有标签栈的时候用

生存时间TTL（8位）：防止兜圈

### 4.9.3 段路由选择协议SR（新一代的MPLS）

MPLS的问题：有关的控制协议(如LDP)比较复杂，拓展性差，运行维护困难，LDP无法做到基于时延或带宽需求的流量调度。为了灵活选择流量转发路径，还要使用资源预留协议RSVP，RSVP非常复杂，每个节点还要维护巨大的链路信息数据库，还不支持等价多路径路由选择，只会选择一条最优路径。

段路由选择协议（Segment Routing，SR）：段（segment）就是标签，也就是转发指令的一种标识符。

SR-MPLS仍然基于标签交换，但不使用LDP，SR由源节点为发送的报文指定路径，把路径转换为有序的段列表（Segment List），即MPLS协议栈，封装在分组首部，其他结点执行首部中的指令（标签）进行转发

SR的整个网络有SDN控制器，控制器手机并掌握全网拓扑信息和链路状态信息，计算出分组应传送的路径，给分组分配SR标签和路径，节点只要转发就好了。

MPLS→SR-MPLS

SDN→SR→SRv6

## 4.10 软件定义网络SDN

OpenFlow：一个得到高度认可的标准，用于在SDN体系结构中控制层面和数据层面之间进行通信，使得控制层面中的控制器可以对数据层面中的物理或虚拟设备进行直接访问和操纵，这种控制在逻辑上是集中式的，是基于流的控制。（由开放网络基金会ONF（Open Networking Foundation）进行制定，这个产业联盟致力于SDN的发展和标准化）

SDN：不是一个协议，不是一个产品，只是一个体系结构，是一种设计、构建和管理网络的新方法或新概念，要点在于把网络的控制层面和数据层面分离，让控制层面利用软件来控制数据层面中的许多设备。

传统意义上数据层面的“转发=“匹配”（匹配转发表）+“动作”（把分组从对应的端口转发出去）

SDN的“匹配”：可以对不同层次（链路层、网络层、运输层）的首部中的字段进行匹配

SDN的“动作”：除了普通的转发分组，还能重写IP首部（就像NAT路由器做的一样），也可以人为阻挡和丢弃一些分组（在SDN中，不管哪一层的数据单元都叫做分组）

分组交换机/OpenFlow交换机/交换机：SDN的广义转发中，完成“匹配+动作的设备”

流表（flow table）：SDN中取代传统转发表，作为“匹配+动作”的转发表

流：OpenFlow官方文档未定义，但一个流就是穿过网络的一种分组序列，在这个序列中的分组都共享分组首部某些字段的值。

流标项（flow entry）：<首部字段/匹配字段,计数器,动作>

首部字段/匹配字段：用于使入分组（incoming packet）的对应首部与之相匹配，匹配不上就丢弃或者发送到远程控制器做更多的处理。

计数器：一组计数器，包括已经与该表项匹配的分组数量、从该表项上次更新到现在经历的时间

动作：一组动作，如：转发到某个指明的端口、丢弃该分组、复制后从多个端口转发、重写首部字段

SDN的功能：转发（基本功能）、负载均衡、防火墙……

SDN的关键特征：基于流的转发、数据层面与控制层面分离（去耦合）、位于数据层面交换机以外的网络控制功能/控制平面是用软件实现的、可编程的网络

南向API：SDN控制器和下面的数据层面的受控设备的通信接口

北向API：SDN控制器和上面的网络控制应用程序的接口

SDN控制器的“通信层：任务是完成SDN控制器和受控的网络设备之间的通信，目前采用的通信协议基本上都是OpenFlow，还要向SDN控制器传送在本地观察到的事件。

SDN控制器的“网络范围的状态管理层：维护网络范围状态（全网的设备状态，全网设备的流表的副本）

SDN控制器的“到网络控制应用程序层的接口”：用于和网络控制程序的交互，允许网络控制应用程序对状态管理层里面的网络状态和流表进行读写操作，对应用程序通告网络时间并采取相应动作，采用较多的是表述性状态传递（Representational State Transfer，REST），REST风格的API，是一组针对网络应用的设计和开发方法。

开源控制器（Open Source Controller）：开放源代码的控制器，如OpenDaylight、ONOS
